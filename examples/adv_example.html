<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2023b"><title>Reading ADV Data with MHKiT</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(192, 76, 11); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.S1 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S2 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.CodeBlock { background-color: #F5F5F5; margin: 10px 0 10px 0; }
.S3 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 1px solid rgb(217, 217, 217); border-bottom: 0px none rgb(33, 33, 33); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S4 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(217, 217, 217); border-radius: 0px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S5 { color: rgb(33, 33, 33); padding: 10px 0px 6px 17px; background: rgb(255, 255, 255) none repeat scroll 0% 0% / auto padding-box border-box; font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px; overflow-x: hidden; line-height: 17.234px;  }
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsErrorElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsErrorElement .diagnosticMessage-errorType {    overflow: auto;}
.embeddedOutputsErrorElement.inlineElement {}
.embeddedOutputsErrorElement.rightPaneElement {}
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsWarningElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsWarningElement .diagnosticMessage-warningType {    overflow: auto;}
.embeddedOutputsWarningElement.inlineElement {}
.embeddedOutputsWarningElement.rightPaneElement {}
/* Copyright 2015-2023 The MathWorks, Inc. *//* In this file, styles are not scoped to rtcContainer since they could be in the Dojo Tooltip */.diagnosticMessage-wrapper {    font-family: Menlo, Monaco, Consolas, "Courier New", monospace;    font-size: 12px;}
.diagnosticMessage-wrapper.diagnosticMessage-warningType {    /*This fallback value will be used for appdesigner warnings*/    color: var(--rtc-warning-output-color, var(--mw-color-matlabWarning));}
.diagnosticMessage-wrapper.diagnosticMessage-warningType a {    /*This fallback value will be used for appdesigner warnings*/    color: var(--rtc-warning-output-color, var(--mw-color-matlabWarning));    text-decoration: underline;}
.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-warningType,.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-warningType a {    color: var(--mw-color-matlabWarning) !important;}
.diagnosticMessage-wrapper.diagnosticMessage-errorType {    /*This fallback value will be used in appdesigner error tooltip text*/    color: var(--rtc-error-output-color, var(--mw-color-matlabErrors));}
.diagnosticMessage-wrapper.diagnosticMessage-errorType a {    /*This fallback value will be used in appdesigner error tooltip text*/    color: var(--rtc-error-output-color, var(--mw-color-matlabErrors));    text-decoration: underline;}
.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-errorType,.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-errorType a {    color: var(--mw-color-matlabErrors) !important;}
.diagnosticMessage-wrapper .diagnosticMessage-messagePart,.diagnosticMessage-wrapper .diagnosticMessage-causePart {    white-space: pre-wrap;}
.diagnosticMessage-wrapper .diagnosticMessage-stackPart {    white-space: pre;}
.embeddedOutputsTextElement,.embeddedOutputsVariableStringElement {    white-space: pre;    word-wrap:  initial;    min-height: 18px;    max-height: 550px;}
.embeddedOutputsTextElement .textElement,.embeddedOutputsVariableStringElement .textElement {    overflow: auto;}
.textElement,.rtcDataTipElement .textElement {    padding-top: 2px;}
.embeddedOutputsTextElement.inlineElement,.embeddedOutputsVariableStringElement.inlineElement {}
.inlineElement .textElement {}
.embeddedOutputsTextElement.rightPaneElement,.embeddedOutputsVariableStringElement.rightPaneElement {    min-height: 16px;}
.rightPaneElement .textElement {    padding-top: 2px;    padding-left: 9px;}
.S6 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S7 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S8 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(217, 217, 217); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>Reading ADV Data with MHKiT</span></h1><div  class = 'S1'><span></span></div><div  class = 'S1'><span>The following example demonstrates a simple workflow for analyzing Acoustic Doppler Velocimetry (ADV) data using MHKiT. MHKiT has brought the DOLfYN codebase in as an MHKiT module for working with ADV and Acoustic Doppler Current Profiler (ADCP) data. The DOLfYN MHKiT module is transferring functionality in two parts. In phase 1 the basic IO and core functions of DOLfYN are brought in. These functions include reading instrument data and rotating through coordinate systems. In phase 2 DOLfYN analysis functions are brought in. As phase 2 is still in progress we will import the analysis tools from the </span><a href = "https://github.com/lkilcher/dolfyn"><span>DOLfYN</span></a><span> package.</span></div><div  class = 'S1'><span>A typical ADV data workflow is broken down into:</span></div><div  class = 'S1'><span>  1. Review the raw data</span></div><div  class = 'S1'><span>      - Check timestamps</span></div><div  class = 'S1'><span>      - Look at velocity data quality, particularly for spiking</span></div><div  class = 'S1'><span>  2. Check for spurious datapoints and remove. Replace bad datapoints using interpolation if desired</span></div><div  class = 'S1'><span>  3. Rotate the data into principal flow coordinates (streamwise, cross-stream, vertical)</span></div><div  class = 'S1'><span>  4. Average the data into bins, or ensembles, of a set time length (normally 5 to 10 min)</span></div><div  class = 'S1'><span>  5. Calculate turbulence statistics (turbulence intensity, TKE, Reynolds stresses) of the measured flowfield</span></div><h2  class = 'S2'><span>Read Raw Instrument Data</span></h2><div  class = 'S1'><span></span></div><div  class = 'S1'><span>DOLfYN currently only carries support for the Nortek Vector ADV. The example loaded here is a short clip of data from a test deployment to show DOLfYN's capabilities.</span></div><div  class = 'S1'><span>Start by reading in the raw datafile downloaded from the instrument. The dolfyn_read function reads the raw file and dumps the information into an xarray Dataset, which contains three groups of variables:</span></div><div  class = 'S1'><span>1. Velocity, amplitude, and correlation of the Doppler velocimetry</span></div><div  class = 'S1'><span>2. Measurements of the instrument's bearing and environment</span></div><div  class = 'S1'><span>3. Orientation matrices DOLfYN uses for rotating through coordinate frames.</span></div><div  class = 'S1'><span></span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >adv_file_path = fullfile(pwd, </span><span style="color: #a709f5;">'examples/data/dolfyn/vector_data01.VEC'</span><span >);</span></span></div></div><div class="inlineWrapper outputs"><div  class = 'S4'><span style="white-space: pre"><span >ds = dolfyn_read(adv_file_path);</span></span></div><div  class = 'S5'><div class="inlineElement eoOutputWrapper disableDefaultGestureHandling embeddedOutputsTextElement" uid="C740B99E" prevent-scroll="true" data-testid="output_0" tabindex="-1" style="width: 1216px; white-space: pre; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;"><div class="textElement eoOutputContent" tabindex="-1" data-previous-available-width="1179" data-previous-scroll-height="17" data-hashorizontaloverflow="false" style="max-height: 261px; white-space: pre; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;">End of file at 3000000 bytes.</div></div></div></div></div><div  class = 'S6'><span>To see what's in the dataset, it is recommended that users open the ds variable in the workspace. Alternatively, removing the semicolon in the above line will print the contents of ds.</span></div><h2  class = 'S2'><span>QC'ing Data</span></h2><div  class = 'S1'><span></span></div><div  class = 'S1'><span>In future updates to MHKiT-Matlab's DOLfYN functionality users will be able to QC data and set certain helpful parameters such as deployment height.</span></div><h2  class = 'S2'><span>Coordinate Rotations</span></h2><div  class = 'S1'><span></span></div><div  class = 'S1'><span>The next step is to rotate the velocity data into true East, North, Up (ENU) coordinates.</span></div><div  class = 'S1'><span>ADVs use an internal compass or magnetometer to determine magnetic ENU directions. The set_declination function takes the user supplied magnetic declination (which can be looked up online for specific coordinates) and adjusts the orientation matrix saved within the dataset.</span></div><div  class = 'S1'><span>Instruments save vector data in the coordinate system specified in the deployment configuration file. To make the data useful, it must be rotated through coordinate systems ("beam"&lt;-&gt;"inst"&lt;-&gt;"earth"&lt;-&gt;"principal"), done through the `rotate2` function. If the "earth" (ENU) coordinate system is specified, DOLfYN will automatically rotate the dataset through the necessary coordinate systems to get there. </span></div><div  class = 'S1'><span></span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span style="color: #008013;">%  First set the magnetic declination</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ds = set_declination(ds, 10.0);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #008013;">% Rotate that data from the instrument to earth frame (ENU):</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >ds = rotate2(ds, </span><span style="color: #a709f5;">'earth'</span><span >);</span></span></div></div></div><div  class = 'S1'><span>Once in the true ENU frame of reference, we can calculate the principal flow direction for the velocity data and rotate it into the principal frame of reference (streamwise, cross-stream, vertical). Principal flow directions are aligned with and orthogonal to the flow streamlines at the measurement location. </span></div><div  class = 'S1'><span>First, the principal flow direction must be calculated through calc_principal_heading. As a standard for DOLfYN functions, those that begin with "calc_*" require the velocity data for input. This function is different from others in DOLfYN in that it requires that the user place the output in an attribute called "principal_heading", as shown below.</span></div><div  class = 'S1'><span>Again we use `rotate2` to change coordinate systems.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >ds.attrs.principal_heading = calc_principal_heading(ds.vel.data, true);</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >ds = rotate2(ds, </span><span style="color: #a709f5;">'principal'</span><span >);</span></span></div></div></div><div  class = 'S1'><span>The next step in ADV analysis is to average the velocity data into time bins (ensembles) and calculate turbulence statistics. This and other features (such as the QC mentioned above will be in the next stage of DOLfYN development). </span></div><h2  class = 'S2'><span>Saving and Loading DOLfYN Datasets</span></h2><div  class = 'S1'><span></span></div><div  class = 'S1'><span>Datasets can be saved and loaded using the write_netcdf and read_netcdf functions, respectively. </span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span style="color: #008013;">% Uncomment these lines to save and load to your current working directory</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #008013;">% write_netcdf(ds, 'your_data.nc');</span></span></div></div><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span style="color: #008013;">% ds_saved = read_netcdf('your_data.nc');</span></span></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Reading ADV Data with MHKiT
% 
% 
% The following example demonstrates a simple workflow for analyzing Acoustic 
% Doppler Velocimetry (ADV) data using MHKiT. MHKiT has brought the DOLfYN codebase 
% in as an MHKiT module for working with ADV and Acoustic Doppler Current Profiler 
% (ADCP) data. The DOLfYN MHKiT module is transferring functionality in two parts. 
% In phase 1 the basic IO and core functions of DOLfYN are brought in. These functions 
% include reading instrument data and rotating through coordinate systems. In 
% phase 2 DOLfYN analysis functions are brought in. As phase 2 is still in progress 
% we will import the analysis tools from the <https://github.com/lkilcher/dolfyn 
% DOLfYN> package.
% 
% A typical ADV data workflow is broken down into:
% 
% 1. Review the raw data
% 
% - Check timestamps
% 
% - Look at velocity data quality, particularly for spiking
% 
% 2. Check for spurious datapoints and remove. Replace bad datapoints using 
% interpolation if desired
% 
% 3. Rotate the data into principal flow coordinates (streamwise, cross-stream, 
% vertical)
% 
% 4. Average the data into bins, or ensembles, of a set time length (normally 
% 5 to 10 min)
% 
% 5. Calculate turbulence statistics (turbulence intensity, TKE, Reynolds stresses) 
% of the measured flowfield
%% Read Raw Instrument Data
% 
% 
% DOLfYN currently only carries support for the Nortek Vector ADV. The example 
% loaded here is a short clip of data from a test deployment to show DOLfYN's 
% capabilities.
% 
% Start by reading in the raw datafile downloaded from the instrument. The dolfyn_read 
% function reads the raw file and dumps the information into an xarray Dataset, 
% which contains three groups of variables:
% 
% 1. Velocity, amplitude, and correlation of the Doppler velocimetry
% 
% 2. Measurements of the instrument's bearing and environment
% 
% 3. Orientation matrices DOLfYN uses for rotating through coordinate frames.
% 
% 

adv_file_path = fullfile(pwd, 'examples/data/dolfyn/vector_data01.VEC');
ds = dolfyn_read(adv_file_path);
%% 
% To see what's in the dataset, it is recommended that users open the ds variable 
% in the workspace. Alternatively, removing the semicolon in the above line will 
% print the contents of ds.
%% QC'ing Data
% 
% 
% In future updates to MHKiT-Matlab's DOLfYN functionality users will be able 
% to QC data and set certain helpful parameters such as deployment height.
%% Coordinate Rotations
% 
% 
% The next step is to rotate the velocity data into true East, North, Up (ENU) 
% coordinates.
% 
% ADVs use an internal compass or magnetometer to determine magnetic ENU directions. 
% The set_declination function takes the user supplied magnetic declination (which 
% can be looked up online for specific coordinates) and adjusts the orientation 
% matrix saved within the dataset.
% 
% Instruments save vector data in the coordinate system specified in the deployment 
% configuration file. To make the data useful, it must be rotated through coordinate 
% systems ("beam"<->"inst"<->"earth"<->"principal"), done through the `rotate2` 
% function. If the "earth" (ENU) coordinate system is specified, DOLfYN will automatically 
% rotate the dataset through the necessary coordinate systems to get there. 
% 
% 

%  First set the magnetic declination
ds = set_declination(ds, 10.0);

% Rotate that data from the instrument to earth frame (ENU):
ds = rotate2(ds, 'earth');
%% 
% Once in the true ENU frame of reference, we can calculate the principal flow 
% direction for the velocity data and rotate it into the principal frame of reference 
% (streamwise, cross-stream, vertical). Principal flow directions are aligned 
% with and orthogonal to the flow streamlines at the measurement location. 
% 
% First, the principal flow direction must be calculated through calc_principal_heading. 
% As a standard for DOLfYN functions, those that begin with "calc_*" require the 
% velocity data for input. This function is different from others in DOLfYN in 
% that it requires that the user place the output in an attribute called "principal_heading", 
% as shown below.
% 
% Again we use `rotate2` to change coordinate systems.

ds.attrs.principal_heading = calc_principal_heading(ds.vel.data, true);
ds = rotate2(ds, 'principal');
%% 
% The next step in ADV analysis is to average the velocity data into time bins 
% (ensembles) and calculate turbulence statistics. This and other features (such 
% as the QC mentioned above will be in the next stage of DOLfYN development). 
%% Saving and Loading DOLfYN Datasets
% 
% 
% Datasets can be saved and loaded using the write_netcdf and read_netcdf functions, 
% respectively. 

% Uncomment these lines to save and load to your current working directory
% write_netcdf(ds, 'your_data.nc');
% ds_saved = read_netcdf('your_data.nc');
##### SOURCE END #####
-->
</div></body></html>